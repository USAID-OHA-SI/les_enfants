---
title: "`r paste('PVT  Overview Report:', '- FY', params$fiscal_year, 'Quarter', params$quarter)`"
output: html_document
params:
  fiscal_year: 2024
  quarter: 4
---


### All charts and tables use USAID-specific data. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)

###################### INTRODUCTION ---------------------------------------------------

# Steps for creating the automated adolescent general report:
    #1. Download the OUxIM country file combined 
    #2. Run creating PVT df by country.R file to create the summary dataframes 
    #3. Run the RMarkdown file to generate the report   ***** this code represents this step *****

library(tidyverse)
library(ggplot2)
library(kableExtra)
library(knitr)
library(scales)
library(plotly)


rm(list = ls())

load(file = 'C:/Users/georg/Desktop/databases/output/PVT/PVT_OU_df.rda')


# Replace Inf and -Inf with NA across all columns in the dataframe
PVT_OU_df[] <- lapply(PVT_OU_df, function(col) {
  if (is.numeric(col)) {
    col[is.infinite(col)] <- NA
  }
  return(col)
})



# Get the current date and time
creation_time <- Sys.time()
formatted_time <- format(creation_time, "%Y-%m-%d %H:%M:%S")

```

`r formatted_time`

<br> 

```{r functions}

####  barchart function  ----------------------------------------------------


create_highlighted_barplot <- function(
  data, 
  indicator_selected, 
  y_label, 
  title,
  caption_selected,
  y_min = NA,
  y_max = NA  # Default to NA; only use if user specifies
) {
  # 1. Capture the user's indicator input as a symbol for tidy evaluation
  indicator_sym <- rlang::ensym(indicator_selected)
  
  # 2. Prepare data for plotting
  plot_data <- data %>%
    # a) Select relevant columns, renaming the user-chosen indicator to "indicator"
    select(
      country, 
      indicator = !!indicator_sym,  # Use the captured symbol as a column name
      fiscal_year, 
      quarter
    ) %>%
    # b) Filter out rows where "indicator" is NA
    filter(!is.na(indicator))
  
  # 3. Flag "ALL" country for highlighting
  plot_data <- plot_data %>%
    mutate(highlight = ifelse(country == "ALL", "Selected", "Other"))
  
  # 4. Create a custom order for countries based on indicator values
  country_order <- plot_data %>%
    arrange(desc(indicator)) %>%
    distinct(country) %>%    # Keep just the first occurrence
    pull(country)
  
  # 5. Factor the 'country' based on this unique ordering
  plot_data <- plot_data %>%
    mutate(
      country = factor(country, levels = country_order)
    )
  
  # 6. Construct a subtitle from fiscal_year and quarter
  fiscal_year <- unique(plot_data$fiscal_year)
  quarter <- unique(plot_data$quarter)
  subtitle <- paste("Fiscal Year:", fiscal_year, "| Quarter:", quarter)
  
  # 7. Build the base plot
  p <- ggplot(plot_data, aes(x = country, y = indicator, fill = highlight)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
    # We DON'T set limits here, so no data is removed
    scale_y_continuous(labels = scales::comma_format()) +
    scale_fill_manual(values = c("Selected" = "#F36428", "Other" = "#8C8C91")) +
    
    # Add geom_text only for the "ALL" (highlight == "Selected") rows
    geom_text(
      data = subset(plot_data, highlight == "Selected"),
      aes(label = round(indicator, 1)),
      vjust = -0.5,
      size = 3,
      color = "black"
    ) +
    labs(
      title = title,
      subtitle = subtitle,
      x = "",
      y = y_label,
      fill = "Highlight",
      caption = caption_selected
    ) +
    theme_classic() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(face = "bold", hjust = 0.5),
      legend.position = "right"
    )
  
  # 8. Conditionally add coord_cartesian() only if y_min and y_max are provided
  if (!is.na(y_min) && !is.na(y_max)) {
    p <- p + coord_cartesian(ylim = c(y_min, y_max))
  }
  
  return(p)
}





```




```{r summary stats listed}

### Summary stats --------------------------------------------------

# Filter and summarize the data for country == 'ALL', FY2024, Q4
table_all_fy2024_q4 <- PVT_OU_df %>%
  filter(country == "ALL", fiscal_year == 2024, quarter == "4")



# Assign each metric to individual variables
total_HIVpos_infants = table_all_fy2024_q4$PMTCT_HEI_POS_N
total_HIVpos_ANC_clients <- table_all_fy2024_q4$PMTCT_STAT_POS_N
total_HIVpos_ANC_clients_on_ART <- table_all_fy2024_q4$PMTCT_ART_N
total_PMTCT_ART_coverage_total <- table_all_fy2024_q4$PMTCT_ART_coverage_total
total_viral_suppression <- table_all_fy2024_q4$viral_suppression
total_ED_coverage_2mo <- table_all_fy2024_q4$EID_coverage_2mo
total_EID_coverage <- table_all_fy2024_q4$EID_coverage
total_HEI_pos_2mo <- table_all_fy2024_q4$HEI_pos_2mo
total_HEI_pos_12mo <- table_all_fy2024_q4$HEI_pos_12mo
total_HEI_pos_linkage_ART_proxy <- table_all_fy2024_q4$HEI_pos_linkage_ART_proxy


```

<br> 

## Summary for FY2024 Q4 - Prevention of vertical transmission 

Key metrics for **FY2024 Q4**:

- **HIV-Positive Infants:** `r format(total_HIVpos_infants, big.mark = ",", scientific = FALSE)`

- **HIV-Positive ANC Clients:** `r format(total_HIVpos_ANC_clients, big.mark = ",", scientific = FALSE)`
- **HIV-Positive ANC Clients on ART:** `r format(total_HIVpos_ANC_clients_on_ART, big.mark = ",", scientific = FALSE)`
- **PMTCT ART Coverage (Total):** `r format(total_PMTCT_ART_coverage_total, big.mark = ",", scientific = FALSE)`
- **Viral Suppression (PMTCT):** `r format(total_viral_suppression, big.mark = ",", scientific = FALSE)`%
- **EID Coverage (≤2 Months):** `r format(total_ED_coverage_2mo, big.mark = ",", scientific = FALSE)`%
- **Overall EID Coverage (12 months):** `r format(total_EID_coverage, big.mark = ",", scientific = FALSE)`%
- **HEI Positivity ≤2 Months:** `r format(total_HEI_pos_2mo, big.mark = ",", scientific = FALSE)`%
- **HEI Positivity ≤12 Months:** `r format(total_HEI_pos_12mo, big.mark = ",", scientific = FALSE)`%
- **HEI Positivity Linkage to ART (Proxy):** `r format(total_HEI_pos_linkage_ART_proxy, big.mark = ",", scientific = FALSE)`%

<br>

-------------------------------------------------------------------------------

## HIV-exposed and HIV-positive infants 


<br>

```{r PMTCT_HEI_POS for infants trend graph, fig.height=5, fig.width=10}

#### HIV + infants ----------------------------

# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL")

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    PMTCT_HEI_POS_N = format(round(PMTCT_HEI_POS_N, 0), big.mark = ","),
    PMTCT_HEI_POS_2MO_N = format(round(PMTCT_HEI_POS_2MO_N, 0), big.mark = ","),
    PMTCT_HEI_POS_Two_Twelve_Months_N = format(round(PMTCT_HEI_POS_Two_Twelve_Months_N, 0), big.mark = ",")
  )

caption_text <- paste0(
  "HIV-Positive Infant Metrics:
  HIV-Positive Infants (Total): PMTCT_HEI_POS_N
  HIV-Positive Infants (<2 Months): PMTCT_HEI_POS_2MO_N
  HIV-Positive Infants (2-12 Months): PMTCT_HEI_POS_Two_Twelve_Months_N \n", 
  
  "Most recent values (2024 Q4)\n",
  "HIV-Positive Infants (Total): ", latest_values$PMTCT_HEI_POS_N, "\n",
  "HIV-Positive Infants (<2 Months): ", latest_values$PMTCT_HEI_POS_2MO_N, "\n",
  "HIV-Positive Infants (2-12 Months): ", latest_values$PMTCT_HEI_POS_Two_Twelve_Months_N
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = PMTCT_HEI_POS_N, color = "HIV-Positive Infants (Total)", group = 1), linewidth = 1) +
  geom_point(aes(y = PMTCT_HEI_POS_N, color = "HIV-Positive Infants (Total)"), size = 2) +
  geom_line(aes(y = PMTCT_HEI_POS_2MO_N, color = "HIV-Positive Infants (<2 Months)", group = 2), linewidth = 1) +
  geom_point(aes(y = PMTCT_HEI_POS_2MO_N, color = "HIV-Positive Infants (<2 Months)"), size = 2) +
  geom_line(aes(y = PMTCT_HEI_POS_Two_Twelve_Months_N, color = "HIV-Positive Infants (2-12 Months)", group = 3), linewidth = 1) +
  geom_point(aes(y = PMTCT_HEI_POS_Two_Twelve_Months_N, color = "HIV-Positive Infants (2-12 Months)"), size = 2) +
  scale_color_manual(
    values = c(
      "HIV-Positive Infants (Total)" = "#2057A7",                # OHA Denim
      "HIV-Positive Infants (<2 Months)" = "#F2BC40",           # Golden Sand
      "HIV-Positive Infants (2-12 Months)" = "#287C6F"          # Genoa
    )
  ) +
  scale_y_continuous(labels = scales::comma_format(), 
                     limits = c(0, 1200)) +
  labs(
    title = "Trend of Number of HIV-Positive Infants Across USAID supported sites",
    subtitle = "by age at test collection",
    x = "  ",
    y = "Number of Infants",
    color = "Metrics",
    caption = caption_text) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 6)
  )

```


<br>

```{r HEI_POS_ART trend graph, fig.height=5, fig.width=10}

#### HEI_POS_ART trend graph -------------------------------------------------



# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL")

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    PMTCT_HEI_POS_N = format(round(PMTCT_HEI_POS_N, 0), big.mark = ","),
    PMTCT_HEI_POS_ART_N = format(round(PMTCT_HEI_POS_ART_N, 0), big.mark = ",")
  )

caption_text <- paste0( "HIV-Positive Infant Metrics:
  HIV-Positive Infants (Total): PMTCT_HEI_POS_N
  HIV-Positive Infants on ART: PMTCT_HEI_POS_ART_N \n \n", 
  "Most recent values (2024 Q4)\n",
  "HIV-Positive Infants (Total): ", latest_values$PMTCT_HEI_POS_N, "\n",
  "HIV-Positive Infants on ART: ", latest_values$PMTCT_HEI_POS_ART_N
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = PMTCT_HEI_POS_N, color = "HIV-Positive Infants (Total)", group = 1), linewidth = 1) +
  geom_point(aes(y = PMTCT_HEI_POS_N, color = "HIV-Positive Infants (Total)"), size = 2) +
  geom_line(aes(y = PMTCT_HEI_POS_ART_N, color = "HIV-Positive Infants on ART", group = 2), linewidth = 1) +
  geom_point(aes(y = PMTCT_HEI_POS_ART_N, color = "HIV-Positive Infants on ART"), size = 2) +
  scale_color_manual(
    values = c(
      "HIV-Positive Infants (Total)" = "#2057A7",  # OHA Denim
      "HIV-Positive Infants on ART" = "#F2BC40"   # Golden Sand
    )
  ) +
  scale_y_continuous(
    limits = c(600, 1100), 
    breaks = seq(600, 1100, by = 100), 
    labels = scales::comma_format()
  ) +
  labs(
    title = "Trend of HIV-Positive Infants and ART Coverage",
    x = " ",
    y = "Number of Infants",
    color = "Metrics",
    caption = caption_text) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 6)
  )
  
  


```

<br> 



```{r PMTCT_HEI_POS for infants by country plotly, fig.height=6, fig.width=10}

##### HIV pos infants by country ---------------------------------------------

# Load necessary libraries
library(dplyr)
library(ggplot2)


# Filter data for trend
df_country_trend <- PVT_OU_df %>%
  filter(country != 'ALL') %>% 
  filter(!is.na(PMTCT_HEI_POS_N)) %>%  # Remove rows with NA values in PMTCT_HEI_POS_N
  select(country, fiscal_year, quarter, PMTCT_HEI_POS_N) %>%  # Select relevant columns
  mutate(period = paste(fiscal_year, "Q", quarter, sep = ""))  # Create a period column

# Create the base ggplot
p <- ggplot(df_country_trend, aes(x = period, y = PMTCT_HEI_POS_N, color = country, group = country)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "Trend of Number of HIV-Positive Infants",
    subtitle = "by country", 
    x = "  ",
    y = "Number of Infants",
    color = "Country"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

# Convert ggplot to interactive plotly
interactive_plot <- ggplotly(p)

# Show the interactive plot
interactive_plot


```





```{r HEI positivity trend graph, fig.height=5, fig.width=10}


### HEI positivity -------------------------------------


# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL", 
         fiscal_year > 2023)

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    HEI_pos_2mo = round(HEI_pos_2mo, 1),
    HEI_pos_12mo = round(HEI_pos_12mo, 1)
  )

annotation_text <- paste0(
  "Most recent values (2024 Q4)\n",
  "HEI Positivity ≤2 Months: ", latest_values$HEI_pos_2mo, "%\n",
  "HEI Positivity ≤12 Months: ", latest_values$HEI_pos_12mo, "%"
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = HEI_pos_2mo, color = "HEI Positivity ≤2 Months", group = 1), linewidth = 1) +
  geom_point(aes(y = HEI_pos_2mo, color = "HEI Positivity ≤2 Months"), size = 2) +
  geom_line(aes(y = HEI_pos_12mo, color = "HEI Positivity ≤12 Months", group = 2), linewidth = 1) +
  geom_point(aes(y = HEI_pos_12mo, color = "HEI Positivity ≤12 Months"), size = 2) +
  scale_color_manual(
    values = c(
      "HEI Positivity ≤2 Months" = "#2057A7", # OHA Denim
      "HEI Positivity ≤12 Months" = "#F2BC40" # Golden Sand
    )
  ) +
  scale_y_continuous(limits = c(0, 2), breaks = seq(0, 2, by = 1)) +
  labs(
    title = "Trend of HEI Positivity",
    x = " ",
    y = "Percentage (%)",
    color = "Metrics",
    caption = "HEI Positivity Variables Calculation:
    - HEI Positivity ≤2 Months: PMTCT_HEI_POS_2MO_N / PMTCT_HEI_N_2MO_N
    - HEI Positivity ≤12 Months: PMTCT_HEI_POS_N / PMTCT_HEI_N"
  ) +
  annotate(
    "text",
    x = 2, y = 0.5,  # Adjust position as needed
    label = annotation_text,
    hjust = 0,
    vjust = 1,
    size = 3,
    color = "black"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 9)
  )


```

<br>



```{r HEI positivity barplot, fig.height=5, fig.width=10}

### HEI pos  ------------------------------------------------


# 1. Filter relevant rows (FY2024, Q4) and pivot the two HEI variables
plot_data <- PVT_OU_df %>%
  filter(fiscal_year == 2024, quarter == 4) %>%
  select(country, HEI_pos_12mo, HEI_pos_2mo) %>%
  pivot_longer(
    cols = c(HEI_pos_12mo, HEI_pos_2mo),
    names_to = "indicator",
    values_to = "value"
  ) %>%
  filter(!is.na(value))

# 2. Create a country ordering by descending HEI_pos_12mo
country_order <- PVT_OU_df %>%
  filter(fiscal_year == 2024, quarter == 4) %>%
  arrange(desc(HEI_pos_12mo)) %>%
  distinct(country) %>%
  pull(country)

# 3. Factor `country` and `indicator`
#    Also truncate value at 6
plot_data <- plot_data %>%
  mutate(
    country   = factor(country, levels = country_order),
    indicator = factor(indicator, levels = c("HEI_pos_2mo", "HEI_pos_12mo")),
    value     = ifelse(value > 6, 6, value)
  )

# --- NEW: highlight which bars are 'ALL' vs. not-ALL, combined with indicator
plot_data <- plot_data %>%
  mutate(
    highlight_group = case_when(
      country == "ALL" & indicator == "HEI_pos_2mo"  ~ "ALL_2mo",
      country == "ALL" & indicator == "HEI_pos_12mo" ~ "ALL_12mo",
      indicator == "HEI_pos_2mo"                     ~ "NOTALL_2mo",
      TRUE                                           ~ "NOTALL_12mo"
    )
  )

# 4. Plot with grouped bars
ggplot(plot_data, aes(x = country, y = value, fill = highlight_group)) +
  geom_col(position = position_dodge(width = 0.8)) +
  # --- NEW: Add text labels for the 'ALL' bars only
  geom_text(
    data = subset(plot_data, country == "ALL"),
    aes(label = scales::comma_format()(value), group = indicator),
    position = position_dodge(width = 0.8),
    vjust = -1,
    size = 3
  ) +
  scale_fill_manual(
    # We’ll keep the original colors for 'ALL', but use gray for others
    values = c(
      "ALL_2mo"    = "#F2BC40",  # Golden Sand
      "ALL_12mo"   = "#C43D4D",  # Old Rose
      "NOTALL_2mo" = "lightgray",
      "NOTALL_12mo"= "darkgray"
    ),
    # Provide legend labels in a user-friendly manner
    labels = c(
      "ALL_2mo"    = "HEI Pos 2 mo (ALL)",
      "ALL_12mo"   = "HEI Pos 12 mo (ALL)",
      "NOTALL_2mo" = "HEI Pos 2 mo",
      "NOTALL_12mo"= "HEI Pos 12 mo"
    )
  ) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "0-2 and 2-12 month positivity for FY2024, Q4",
    x = NULL,
    y = "Percentage positive",
    fill = "Indicator Group", 
    caption = "Values greater than 6% truncated at 6% for viewing"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  )





```


<br>


```{r HEI_positivity by country, fig.height=7, fig.width=10}

### plotly HIV positive infant data by country ---------------------------------------------

# Filter data for trend
df_country_trend <- PVT_OU_df %>%
  filter(!is.na(HEI_pos_2mo), 
         HEI_pos_2mo < 10) %>%  
  select(country, fiscal_year, quarter, HEI_pos_2mo, PMTCT_HEI_POS_2MO_N) %>%  # Select relevant columns
  mutate(period = paste(fiscal_year, "Q", quarter, sep = ""), 
         PMTCT_HEI_POS_2MO_N_plus_1 = PMTCT_HEI_POS_2MO_N + 1) 

# Create the base ggplot
p <- ggplot(df_country_trend, aes(x = period, y = HEI_pos_2mo, color = country, group = country)) +
  geom_line(linewidth = 1) +
  geom_point(alpha = 0.7) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "Trend of HEI Positivity ≤2 Months by Country",
    x = "  ",
    y = "HEI Positivity ≤2 Months (%)",
    color = "Country"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

ggplotly(p)
```


<br>


```{r EID coverage positivity trend graph , fig.height=5, fig.width=10}



### EID coverage positivity trend graph ---------------------------------

# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL")

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    EID_coverage_2mo = round(EID_coverage_2mo, 1),
    EID_coverage = round(EID_coverage, 1)
  )
# Corrected annotation text
caption_text <- paste0(
  "EID Coverage Variables Calculation:
   EID Coverage ≤2 Months: PMTCT_EID_Less_Equal_Two_Months_N / PMTCT_EID_D
   Overall EID Coverage (12 Months): PMTCT_EID_N / PMTCT_EID_D \n \n", 
  "Most recent values (2024 Q4)\n",
  "EID Coverage ≤2 Months: ", latest_values$EID_coverage_2mo, "%\n",
  "Overall EID Coverage (12 Months): ", latest_values$EID_coverage, "%"
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = EID_coverage_2mo, color = "EID Coverage ≤2 Months", group = 1), linewidth = 1) +
  geom_point(aes(y = EID_coverage_2mo, color = "EID Coverage ≤2 Months"), size = 2) +
  geom_line(aes(y = EID_coverage, color = "Overall EID Coverage (12 Months)", group = 2), linewidth = 1) +
  geom_point(aes(y = EID_coverage, color = "Overall EID Coverage (12 Months)"), size = 2) +
  scale_color_manual(
    values = c(
      "EID Coverage ≤2 Months" = "#2057A7", # OHA Denim
      "Overall EID Coverage (12 Months)" = "#F2BC40" # Golden Sand
    )
  ) +
  scale_y_continuous(limits = c(50, 150), breaks = seq(50, 150, by = 25)) +
  labs(
    title = "Trend of EID Coverage",
    subtitle = "PMTCT_EID: Percentage of infants born to women living with HIV who received 
a virologic HIV test (sample collected) by 12 months of age", 
    x = " ",
    y = "Percentage (%)",
    color = "Metrics",
    caption = caption_text) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 9)
  )



```

<br> 


```{r EID coverage bar plot , fig.height=5, fig.width=10}

create_highlighted_barplot(
  data = PVT_OU_df %>%
    filter(fiscal_year == 2024, quarter == 4),  # Filter for FY2024 Q4
  indicator_selected = "EID_coverage_2mo",      # Indicator column to plot
  y_label = "EID Coverage ≤2 Months (%)",       # Y-axis label
  title = "EID Coverage ≤2 Months by Country (FY2024 Q4)",  # Plot title
  caption_selected = "EID Coverage ≤2 Months = (PMTCT_EID_Less_Equal_Two_Months_N / PMTCT_EID_D) * 100.
PMTCT_EID_Less_Equal_Two_Months_N: Number of infants with early infant diagnosis ≤2 months.
PMTCT_EID_D: Total infants eligible for early infant diagnosis."
)


```

<br>



```{r missed reporting proxy , fig.height=5, fig.width=10}

### Missed reporting proxy -------------------------------------------------

create_highlighted_barplot(
  data = PVT_OU_df %>%
    filter(fiscal_year == 2024, quarter == 4) %>%
    mutate(
      Missed_reporting_proxy = ifelse(Missed_reporting_proxy < -10, -10, Missed_reporting_proxy)),                
  indicator_selected = "Missed_reporting_proxy",  # Indicator column to plot
  y_label = "Missed Reporting Proxy (%)",         # Y-axis label
  title = "Missed Reporting Proxy by Country (higher number means more missed reporting)",    # Plot title
  caption_selected = "Missed Reporting Proxy = (1 - (PMTCT_HEI_N / PMTCT_EID_N)) * 100.
PMTCT_EID: infants who had sample collected by 12 months.
PMTCT_HEI: infants who had a virologic test result returned."
)


```


<br> 

<br> 

## Maternal testing 

<br>

```{r ANC1 trend graph, fig.height=5, fig.width=10}

### ANC1 clients trend  ---------------------------------------------------


# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL")

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    PMTCT_STAT_D = format(round(PMTCT_STAT_D, 0), big.mark = ","),
    PMTCT_STAT_N = format(round(PMTCT_STAT_N, 0), big.mark = ",")
  )

caption_text <- paste0( "PMTCT_STAT Metrics:
  - PMTCT_STAT_D: Total number of ANC1 clients.
  - PMTCT_STAT_N: Total number of clients with known HIV status.
- Dip in FY2023 Q4 due to Nigeria data issues \n", 
  "Most recent values (2024 Q4)\n",
  "Total ANC1 Clients: ", latest_values$PMTCT_STAT_D, "\n",
  "Clients with Known HIV Status: ", latest_values$PMTCT_STAT_N
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = PMTCT_STAT_D, color = "PMTCT_STAT_D (Total ANC1 Clients)", group = 1), linewidth = 1) +
  geom_point(aes(y = PMTCT_STAT_D, color = "PMTCT_STAT_D (Total ANC1 Clients)"), size = 2) +
  geom_line(aes(y = PMTCT_STAT_N, color = "Clients with Known HIV Status", group = 2), linewidth = 1) +
  geom_point(aes(y = PMTCT_STAT_N, color = "Clients with Known HIV Status"), size = 2) +
  scale_color_manual(
    values = c(
      "PMTCT_STAT_D (Total ANC1 Clients)" = "#2057A7", # OHA Denim
      "Clients with Known HIV Status" = "#F2BC40"     # Golden Sand
    )
  ) +
  scale_y_continuous(labels = scales::comma_format(), 
                     limits = c(700000, 1500000)) +
  labs(
    title = "Trend of ANC1 Clients and Known HIV Status",
    x = "",
    y = "Number of Clients",
    color = "Metrics",
    caption = caption_text) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 6)
  )

```

<br>

```{r ANC1 missed number bar chart, fig.height=5, fig.width=10}
### ANC1 missed number --------------------------------------------------



create_highlighted_barplot(
  data = PVT_OU_df %>%
    filter(fiscal_year == 2024, quarter == 4, country != 'ALL'),  # Filter for FY2024 Q4
  indicator_selected = "ANC1_missed_number",   # Indicator column to plot
  y_label = "Number of Women Not Tested for HIV at ANC1",  # Y-axis label
  title = "Missed HIV Testing at ANC1 by Country (FY2024 Q4)",  # Plot title
  caption_selected = "ANC1 Missed Number = (PMTCT_STAT_D - PMTCT_STAT_N).")

```


<br>
```{r ANC1 missed number total trend , fig.height=5, fig.width=10}

### trend missed number 
#### trend overall 

# Filter for country == "ALL" and calculate ANC1_missed_number
df_all <- PVT_OU_df %>%
  mutate(ANC1_missed_number = PMTCT_STAT_D - PMTCT_STAT_N) %>%  # Calculate ANC1_missed_number
  filter(country == "ALL")  # Filter for country == "ALL"

ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""), y = ANC1_missed_number, group = 1)) +
  geom_line(color = "#2057A7", linewidth = 1.5) +  # OHA Denim for the line
  geom_point(color = "#2057A7", size = 3) +        # Golden Sand for the points
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "Trend of Missed HIV Testing at ANC1 (Country: ALL)",
    x = "  ",
    y = "Number of Women Not Tested for HIV",
    caption = "ANC1 Missed Number = PMTCT_STAT_D - PMTCT_STAT_N."
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )


```


<br>

```{r ANC HIV +, fig.height=5, fig.width=10}

#### ANC1 ART HIV trend graph   -------------------------------------------

# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL")

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    PMTCT_STAT_POS_N = format(round(PMTCT_STAT_POS_N, 0), big.mark = ","),
    PMTCT_STAT_POS_N_HIV_known_at_entry = format(round(PMTCT_STAT_POS_N_HIV_known_at_entry, 0), big.mark = ","),
    PMTCT_STAT_POS_N_HIV_newly_diagnosed = format(round(PMTCT_STAT_POS_N_HIV_newly_diagnosed, 0), big.mark = ","),
    PMTCT_ART_N = format(round(PMTCT_ART_N, 0), big.mark = ",")
  )

caption_text <- paste0("HIV-Positive Metrics and ART:
  HIV-Positive (Total): PMTCT_STAT_POS_N
  HIV-Positive Known at Entry: PMTCT_STAT_POS_N_HIV_known_at_entry
  HIV-Positive Newly Diagnosed: PMTCT_STAT_POS_N_HIV_newly_diagnosed
  HIV-Positive on ART: PMTCT_ART_N \n \n", 
  "Most recent values (2024 Q4)\n",
  "HIV-Positive (Total): ", latest_values$PMTCT_STAT_POS_N, "\n",
  "HIV-Positive Known at Entry: ", latest_values$PMTCT_STAT_POS_N_HIV_known_at_entry, "\n",
  "HIV-Positive Newly Diagnosed: ", latest_values$PMTCT_STAT_POS_N_HIV_newly_diagnosed, "\n",
  "HIV-Positive on ART: ", latest_values$PMTCT_ART_N
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = PMTCT_STAT_POS_N, color = "HIV-Positive (Total)", group = 1), linewidth = 1) +
  geom_point(aes(y = PMTCT_STAT_POS_N, color = "HIV-Positive (Total)"), size = 2) +
  geom_line(aes(y = PMTCT_STAT_POS_N_HIV_known_at_entry, color = "HIV-Positive Known at Entry", group = 2), linewidth = 1) +
  geom_point(aes(y = PMTCT_STAT_POS_N_HIV_known_at_entry, color = "HIV-Positive Known at Entry"), size = 2) +
  geom_line(aes(y = PMTCT_STAT_POS_N_HIV_newly_diagnosed, color = "HIV-Positive Newly Diagnosed", group = 3), linewidth = 1) +
  geom_point(aes(y = PMTCT_STAT_POS_N_HIV_newly_diagnosed, color = "HIV-Positive Newly Diagnosed"), size = 2) +
  geom_line(aes(y = PMTCT_ART_N, color = "HIV-Positive on ART", group = 4), linewidth = 1) +
  geom_point(aes(y = PMTCT_ART_N, color = "HIV-Positive on ART"), size = 2) +
  scale_color_manual(
    values = c(
      "HIV-Positive (Total)" = "#2057A7",                # OHA Denim
      "HIV-Positive Known at Entry" = "#F2BC40",        # Golden Sand
      "HIV-Positive Newly Diagnosed" = "#287C6F",       # Genoa
      "HIV-Positive on ART" = "#C43D4D"                # Old Rose
    )
  ) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "Trend of HIV Diagnoses and ART Coverage for PBFW",
    x = " ",
    y = "Number of Clients",
    color = "Metrics",
    caption = caption_text) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 6)
  )

```

<br> 

```{r ANC1 missed HIV+ women not on ART, fig.height=5, fig.width=10}

### HIV + not on ART -------------------------------

# Filter for country == "ALL" and calculate the number of HIV+ women not on ART
df_all <- PVT_OU_df %>%
  filter(country == "ALL")  # Filter for country == "ALL"

# Create the trend plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""), y = HIV_not_on_ART, group = 1)) +
  geom_line(color = "#2057A7", linewidth = 1.5) +  # OHA Denim for the line
  geom_point(color = "#2057A7", size = 3) +        # Golden Sand for the points
  scale_y_continuous(labels = scales::comma_format()) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +  # Add horizontal line at y = 0
  labs(
    title = "Trend of HIV-Positive Women Not on ART (Country: ALL)",
    x = " ",
    y = "Number of HIV-Positive Women Not on ART",
    caption = "HIV-Positive Women Not on ART = PMTCT_STAT_POS_N - PMTCT_ART_N."
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```


```{r ANC1 missed HIV+ women not on ART barchat, fig.height=5, fig.width=10}

create_highlighted_barplot(
  data = PVT_OU_df %>%
    filter(fiscal_year == 2024, quarter == 4),  # Filter for FY2024 Q4
  indicator_selected = "HIV_not_on_ART",       # Indicator column to plot
  y_label = "Number of HIV-Positive Women Not on ART",  # Y-axis label
  title = "HIV-Positive Women Not on ART by Country (FY2024 Q4)",  # Plot title
  caption_selected = "HIV-Positive Women Not on ART = PMTCT_STAT_POS_N - PMTCT_ART_N.
PMTCT_STAT_POS_N: Total HIV-positive women identified.
PMTCT_ART_N: Total HIV-positive women on ART."
)

```

<br>

<br> 

```{r ANC positivity trend graph, fig.height=5, fig.width=10}


### ANC positivity trend graph ---------------------------------

# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL")

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    positivity_new = round(positivity_new, 1),
    positivity_postANC1_breastfeeding = round(positivity_postANC1_breastfeeding, 1),
    positivity_postANC1_preg = round(positivity_postANC1_preg, 1),
    positivity_overall_ANC = round(positivity_overall_ANC, 1)
  )

caption_text <- paste0("Positivity Variables Calculation:\n
  Overall Positivity (ANC): PMTCT_STAT_POS_N / PMTCT_STAT_N; New Positivity: PMTCT_STAT_POS_N_HIV_newly_diagnosed / PMTCT_STAT_N
  Positivity (Breastfeeding): HTS_TST_POS_N_PMTCT_POSTANC1_breastfeeding / HTS_TST_N_PMTCT_POSTANC1_breastfeeding
  Positivity (Pregnancy): HTS_TST_POS_N_PMTCT_POSTANC1_PregLD / HTS_TST_N_PMTCT_POSTANC1_PregLD \n \n", 
  "Most recent values (2024 Q4)\n",
  "New Positivity: ", latest_values$positivity_new, "%\n",
  "Positivity (Breastfeeding): ", latest_values$positivity_postANC1_breastfeeding, "%\n",
  "Positivity (Pregnancy): ", latest_values$positivity_postANC1_preg, "%\n",
  "Overall Positivity (ANC): ", latest_values$positivity_overall_ANC, "%"
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = positivity_new, color = "New Positivity", group = 1), linewidth = 1) +
  geom_point(aes(y = positivity_new, color = "New Positivity"), size = 2) +
  geom_line(aes(y = positivity_postANC1_breastfeeding, color = "Positivity (Breastfeeding)", group = 2), linewidth = 1) +
  geom_point(aes(y = positivity_postANC1_breastfeeding, color = "Positivity (Breastfeeding)"), size = 2) +
  geom_line(aes(y = positivity_postANC1_preg, color = "Positivity (Pregnancy)", group = 3), linewidth = 1) +
  geom_point(aes(y = positivity_postANC1_preg, color = "Positivity (Pregnancy)"), size = 2) +
  geom_line(aes(y = positivity_overall_ANC, color = "Overall Positivity (ANC)", group = 4), linewidth = 1) +
  geom_point(aes(y = positivity_overall_ANC, color = "Overall Positivity (ANC)"), size = 2) +
  scale_color_manual(
    values = c(
      "New Positivity" = "#2057A7", # OHA Denim
      "Positivity (Breastfeeding)" = "#F2BC40", # Golden Sand
      "Positivity (Pregnancy)" = "#287C6F", # Genoa
      "Overall Positivity (ANC)" = "#C43D4D" # Old Rose
    )
  ) +
  scale_y_continuous(limits = c(0, 7), breaks = seq(0, 7, by = 1)) +
  labs(
    title = "Trend of ANC Positivity ",
    x = " ",
    y = "Percentage (%)",
    color = "Metrics",
    caption = caption_text) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 6)
  )







```


<br> 

<br> 

## Viral suppression among PBFW 

<br>


```{r Viral suppression graphs, fig.height=5, fig.width=10}


#### Viral suppression graph

# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL")


# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    viral_suppression = round(viral_suppression, 1),
    viral_suppression_pregnant = round(viral_suppression_pregnant, 1),
    viral_suppression_breastfeeding = round(viral_suppression_breastfeeding, 1)
  )

caption_text <- paste0(
  "Most recent values (2024 Q4)\n",
  "Viral Suppression: ", latest_values$viral_suppression, "%\n",
  "Viral Suppression (Pregnant): ", latest_values$viral_suppression_pregnant, "%\n",
  "Viral Suppression (Breastfeeding): ", latest_values$viral_suppression_breastfeeding, "%"
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = viral_suppression, color = "Viral Suppression", group = 1), linewidth = 1) +
  geom_point(aes(y = viral_suppression, color = "Viral Suppression"), size = 2) +
  geom_line(aes(y = viral_suppression_pregnant, color = "Viral Suppression (Pregnant)", group = 2), linewidth = 1) +
  geom_point(aes(y = viral_suppression_pregnant, color = "Viral Suppression (Pregnant)"), size = 2) +
  geom_line(aes(y = viral_suppression_breastfeeding, color = "Viral Suppression (Breastfeeding)", group = 3), linewidth = 1) +
  geom_point(aes(y = viral_suppression_breastfeeding, color = "Viral Suppression (Breastfeeding)"), size = 2) +
  scale_color_manual(
    values = c(
      "Viral Suppression" = "#2057A7", # OHA Denim
      "Viral Suppression (Pregnant)" = "#F2BC40", # Golden Sand
      "Viral Suppression (Breastfeeding)" = "#287C6F" # Genoa
    )
  ) +
  scale_y_continuous(limits = c(85, 99), breaks = seq(85, 99, by = 5)) +
  labs(
    title = "Trend of Viral Suppression (TX_PVLS) among PBFW ",
    x = " ",
    y = "Percentage (%)",
    color = "Metrics", 
    caption = caption_text
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

<br> 


```{r viral suppression barplot, fig.height=5, fig.width=10}
### Viral suppression -------------------------------------------------


create_highlighted_barplot(
  data = PVT_OU_df %>%
    filter(fiscal_year == 2024, quarter == 4),  
  indicator_selected = "viral_suppression",     
  y_label = "Viral Suppression (%)", 
  y_min = 75,
  y_max = 110,
  title = "Viral Suppression by Country (FY2024 Q4) among PBFW",  
  caption_selected = "Viral Suppression = (TX_PVLS_N / TX_PVLS_D) * 100.
TX_PVLS_N: Number of individuals with a suppressed viral load (<1000 copies/ml).
TX_PVLS_D: Number of individuals with a viral load result returned."
)



```


<br> 
<br> 

## PrEP among PBFW 


<br>


```{r PrEP CT, fig.height=5, fig.width=10}


### PrEP -------------------------------------------------------------------

# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL", fiscal_year > 2021)

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    PrEP_CT_N = round(PrEP_CT_N, 1),
    PrEP_CT_N_breastfeeding = round(PrEP_CT_N_breastfeeding, 1),
    PrEP_CT_N_pregnant = round(PrEP_CT_N_pregnant, 1)
  )

caption_text <- paste0("PrEP CT Metrics:\n
  PrEP_CT_N: Total number of clients currently on PrEP.
  PrEP_CT_N_breastfeeding: PrEP CT for breastfeeding clients.
  PrEP_CT_N_pregnant: PrEP CT for pregnant clients. \n \n", 
  "Most recent values (2024 Q4)\n",
  "PrEP CT Total: ", latest_values$PrEP_CT_N, "\n",
  "PrEP CT (Breastfeeding): ", latest_values$PrEP_CT_N_breastfeeding, "\n",
  "PrEP CT (Pregnant): ", latest_values$PrEP_CT_N_pregnant
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = PrEP_CT_N, color = "PrEP CT Total", group = 1), linewidth = 1) +
  geom_point(aes(y = PrEP_CT_N, color = "PrEP CT Total"), size = 2) +
  geom_line(aes(y = PrEP_CT_N_breastfeeding, color = "PrEP CT (Breastfeeding)", group = 2), linewidth = 1) +
  geom_point(aes(y = PrEP_CT_N_breastfeeding, color = "PrEP CT (Breastfeeding)"), size = 2) +
  geom_line(aes(y = PrEP_CT_N_pregnant, color = "PrEP CT (Pregnant)", group = 3), linewidth = 1) +
  geom_point(aes(y = PrEP_CT_N_pregnant, color = "PrEP CT (Pregnant)"), size = 2) +
  scale_color_manual(
    values = c(
      "PrEP CT Total" = "#2057A7",              # OHA Denim
      "PrEP CT (Breastfeeding)" = "#F2BC40",   # Golden Sand
      "PrEP CT (Pregnant)" = "#287C6F"         # Genoa
    )
  ) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "Trend of PrEP CT (FY2023-FY2024)",
    x = " ",
    y = "Counts",
    color = "Metrics",
    caption = caption_text) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 9)
  )

```

<br>

```{r PrEP new , fig.height=5, fig.width=10}


# Filter for country == "ALL"
df_all <- PVT_OU_df %>%
  filter(country == "ALL", fiscal_year > 2023)

# Filter for the most recent quarter (2024 Q4)
latest_points <- df_all %>%
  filter(fiscal_year == 2024 & quarter == "4")

# Create the text for the annotation box
latest_values <- latest_points %>%
  summarise(
    PrEP_NEW_N = round(PrEP_NEW_N, 1),
    PrEP_NEW_N_breastfeeding = round(PrEP_NEW_N_breastfeeding, 1),
    PrEP_NEW_N_pregnant = round(PrEP_NEW_N_pregnant, 1)
  )

caption_text <- paste0("PrEP NEW Metrics:\n
  PrEP_NEW_N: Total number of new clients on PrEP.
  PrEP_NEW_N_breastfeeding: PrEP NEW for breastfeeding clients.
  PrEP_NEW_N_pregnant: PrEP NEW for pregnant clients. \n \n", 
  "Most recent values (2024 Q4)\n",
  "PrEP NEW Total: ", latest_values$PrEP_NEW_N, "\n",
  "PrEP NEW (Breastfeeding): ", latest_values$PrEP_NEW_N_breastfeeding, "\n",
  "PrEP NEW (Pregnant): ", latest_values$PrEP_NEW_N_pregnant
)

# Create the plot
ggplot(df_all, aes(x = paste(fiscal_year, "Q", quarter, sep = ""))) +
  geom_line(aes(y = PrEP_NEW_N, color = "PrEP NEW Total", group = 1), linewidth = 1) +
  geom_point(aes(y = PrEP_NEW_N, color = "PrEP NEW Total"), size = 2) +
  geom_line(aes(y = PrEP_NEW_N_breastfeeding, color = "PrEP NEW (Breastfeeding)", group = 2), linewidth = 1) +
  geom_point(aes(y = PrEP_NEW_N_breastfeeding, color = "PrEP NEW (Breastfeeding)"), size = 2) +
  geom_line(aes(y = PrEP_NEW_N_pregnant, color = "PrEP NEW (Pregnant)", group = 3), linewidth = 1) +
  geom_point(aes(y = PrEP_NEW_N_pregnant, color = "PrEP NEW (Pregnant)"), size = 2) +
  scale_color_manual(
    values = c(
      "PrEP NEW Total" = "#2057A7",              # OHA Denim
      "PrEP NEW (Breastfeeding)" = "#F2BC40",   # Golden Sand
      "PrEP NEW (Pregnant)" = "#287C6F"         # Genoa
    )
  ) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "Trend of PrEP NEW (FY2024)",
    x = " ",
    y = "Counts",
    color = "Metrics",
    caption = caption_text
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0, size = 9)
  )





```
  
<br>

<br>

## Comparison tables 

<br> 

```{r}

# Define a common style for titles
title_style <- "color: #2c3e50; font-size:16px; font-weight:bold;"


# 1. Top 5 PVT Countries by Viral Suppression
top5_vs <- PVT_OU_df %>%
  group_by(country, fiscal_year, quarter) %>% 
  filter(TX_PVLS_D >= 100) %>% 
  summarize(VS = mean(viral_suppression, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(fiscal_year), desc(as.numeric(quarter))) %>%
  distinct(country, .keep_all = TRUE) %>%
  arrange(desc(VS)) %>% 
  select(-fiscal_year, -quarter) %>% 
  head(10)

top5_vs %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'> Countries with Highest Viral Suppression in PBFW </span>") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"), 
                position = "left", 
                font_size = 14) %>%
  add_footnote("*Values represent the latest quarterly average Viral Suppression rates.
  Including countries with >=100 PBFW with documented viral loads per quarter", 
               notation = "none")

# 2. PVT Improvement in Viral Suppression (Slope)
PVT_vs_slope <- PVT_OU_df %>%
  filter(fiscal_year >= (max(fiscal_year) - 2), TX_PVLS_D > 50) %>%
  mutate(time_num = fiscal_year + as.numeric(quarter)/4) %>%
  group_by(country) %>%
  filter(n() >= 8) %>% # Ensures at least 8 observations per country
  summarize(
    slope = coef(lm(viral_suppression ~ time_num))[2], 
    .groups = "drop"
  ) %>%
  arrange(desc(slope))


PVT_vs_slope %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'>PVT Improvement in Viral Suppression Over 3 Years (Slope)</span>") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"), 
                position = "left", 
                font_size = 14) %>%
  add_footnote("*Slopes calculated using linear regression over the last 3 fiscal years.", 
               notation = "none")




# 3. Top 5 PVT Countries by Positivity
top5_positivity <- PVT_OU_df %>%
  group_by(country, fiscal_year, quarter) %>%
  summarize(
    Positivity = mean(positivity_overall_ANC, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  arrange(desc(fiscal_year), desc(as.numeric(quarter))) %>%
  distinct(country, .keep_all = TRUE) %>%
  arrange(desc(Positivity)) %>%
  select(-fiscal_year, -quarter) %>% 
  head(10)

top5_positivity %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'> Countries with Highest Positivity in ANC </span>") %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover"), 
    position = "left", 
    font_size = 14
  ) %>%
  add_footnote("*Values represent the latest quarterly average positivity rates in ANC.", 
               notation = "none")


# 2. PVT Increase in Positivity Over 3 Years (Slope)
PVT_positivity_slope <- PVT_OU_df %>%
  filter(fiscal_year >= (max(fiscal_year) - 2), TX_PVLS_D > 50) %>%
  mutate(time_num = fiscal_year + as.numeric(quarter)/4) %>%
  group_by(country) %>%
  filter(n() >= 8) %>% # Ensures at least 8 observations per country
  summarize(
    slope = coef(lm(positivity_overall_ANC ~ time_num))[2], 
    .groups = "drop"
  ) %>%
  arrange(desc(slope))

PVT_positivity_slope %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'>PVT Improvement in Positivity Over 3 Years (Slope)</span>") %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover"), 
    position = "left", 
    font_size = 14
  ) %>%
  add_footnote("*Slopes calculated using linear regression over the last 3 fiscal years.", 
               notation = "none")




# 1.  Countries by Documented HIV-Positive Infants
top5_HEI_POS <- PVT_OU_df %>%
  group_by(country, fiscal_year, quarter) %>%
  summarize(
    HEI_POS = sum(PMTCT_HEI_POS_N, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  arrange(desc(fiscal_year), desc(as.numeric(quarter))) %>%
  distinct(country, .keep_all = TRUE) %>%
  arrange(desc(HEI_POS)) %>%
  select(-fiscal_year, -quarter) %>% 
  head(10)

top5_HEI_POS %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'> Countries with the Highest Number of Documented HIV-Positive Infants </span>") %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover"), 
    position = "left", 
    font_size = 14
  ) %>%
  add_footnote("*Values represent the latest quarterly documented number of HIV-positive infants.", 
               notation = "none")


# 2. Improvement in Documented HIV-Positive Infants (Slope)
PVT_HEI_POS_slope <- PVT_OU_df %>%
  filter(fiscal_year >= (max(fiscal_year) - 2), PMTCT_HEI_POS_N > 5) %>%
  mutate(time_num = fiscal_year + as.numeric(quarter)/4) %>%
  group_by(country) %>%
  filter(n() >= 8) %>% # Ensures at least 8 observations per country
  summarize(
    slope = coef(lm(PMTCT_HEI_POS_N ~ time_num))[2], 
    .groups = "drop"
  ) %>%
  arrange(desc(slope))

PVT_HEI_POS_slope %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'>Change in Documented HIV-Positive Infants Over 3 Years (Slope)</span>") %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover"), 
    position = "left", 
    font_size = 14
  ) %>%
  add_footnote("*Slopes calculated using linear regression over the last 3 fiscal years.", 
               notation = "none")



# 1. Top 5 Countries by Missed Reporting Proxy
top5_Missed_reporting <- PVT_OU_df %>%
  group_by(country, fiscal_year, quarter) %>%
  summarize(
    Missed_Reporting = sum(Missed_reporting_proxy, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  arrange(desc(fiscal_year), desc(as.numeric(quarter))) %>%
  distinct(country, .keep_all = TRUE) %>%
  arrange(desc(Missed_Reporting)) %>%
  select(-fiscal_year, -quarter) %>% 
  head(10)

top5_Missed_reporting %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'> Countries with the Highest Missed Reporting Proxy </span>") %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover"), 
    position = "left", 
    font_size = 14
  ) %>%
  add_footnote("*Values represent the latest quarterly total of missed reporting proxy occurrences.", 
               notation = "none")

# 2. Improvement in Missed Reporting Proxy Over Time (Slope)
PVT_Missed_reporting_slope <- PVT_OU_df %>%
  filter(fiscal_year >= 2024, TX_PVLS_D > 50) %>%
  mutate(time_num = fiscal_year + as.numeric(quarter)/4) %>%
  group_by(country) %>%
  filter(n() >= 3) %>% # Ensures at least 8 observations per country
  summarize(
    slope = coef(lm(Missed_reporting_proxy ~ time_num))[2], 
    .groups = "drop"
  ) %>%
  arrange(desc(slope))

PVT_Missed_reporting_slope %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'> Improvement in Missed Reporting Proxy Over 3 Years (Slope)</span>") %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover"), 
    position = "left", 
    font_size = 14
  ) %>%
  add_footnote("*Slopes calculated using linear regression over the last fiscal year.
  Positive slope corresponds to more missed reporting over time.", 
               notation = "none")




# 1. Countries by Women at ANC1 Without Known HIV Status
top5_ANC1_missed <- PVT_OU_df %>%
  group_by(country, fiscal_year, quarter) %>%
  summarize(
    ANC1_Missed = sum(ANC1_missed_number, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  arrange(desc(fiscal_year), desc(as.numeric(quarter))) %>%
  distinct(country, .keep_all = TRUE) %>%
  arrange(desc(ANC1_Missed)) %>%
  select(country, ANC1_Missed) %>% 
  head(10)

top5_ANC1_missed %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'> Countries with the Highest Number of Women at ANC1 Without Known HIV Status </span>") %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover"), 
    position = "left", 
    font_size = 14
  ) %>%
  add_footnote("*Values represent the latest quarterly total of women at ANC1 without known HIV status.", 
               notation = "none")

# 2. Improvement in Women at ANC1 Without Known HIV Status (Slope)
PVT_ANC1_missed_slope <- PVT_OU_df %>%
  filter(fiscal_year >= (max(fiscal_year) - 2), PMTCT_STAT_D > 50, country != 'ALL') %>%
  mutate(time_num = fiscal_year + as.numeric(quarter)/4) %>%
  group_by(country) %>%
  filter(n() >= 8) %>% # Ensures at least 8 observations per country
  summarize(
    slope = coef(lm(ANC1_missed_number ~ time_num))[2], 
    .groups = "drop"
  ) %>%
  arrange(desc(slope)) 

PVT_ANC1_missed_slope %>%
  kable("html", caption = "<span style='color:#2c3e50; font-size:16px; font-weight:bold;'> Change in Women at ANC1 Without Known HIV Status Over 3 Years (Slope)</span>") %>%
  kable_styling(
    full_width = FALSE, 
    bootstrap_options = c("striped", "hover"), 
    position = "left", 
    font_size = 14
  ) %>%
  add_footnote("*Slopes calculated using linear regression over the last 3 fiscal years.
  Positive slope means increasing numbers of women with unknown HIV status at ANC1 across time", 
               notation = "none")




```



Please contact Paul George (pgeorge@usaid.gov) with any comments/concerns/errors/suggestions for improvement for this report.  


